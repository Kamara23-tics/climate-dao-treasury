import {
  Lucid,
  Blockfrost,
  Constr,
  Data,
} from "https://unpkg.com/lucid-cardano@0.10.11/web/mod.js";

let lucid;
let walletAddress;
let scriptAddress;

/* ===============================
   PLUTUS V2 VALIDATOR (CBOR HEX)
   =============================== */
const CLIMATE_DAO_VALIDATOR = "590f97010000323232323233223233322232323232323232332232323322323232323232323232332232323233322232323232323232323232323232232323232232232325335323232325335003153355335330105001350042222004103f13357389211a70726f706f736572207369676e6174757265206d697373696e670003e1533553353335014501b335015335016503b03f3350183503c35004222200203f355001222222222222005103f133573892011b63616e63656c6c6174696f6e20706572696f6420656c61707365640003e15335333573466e20ccc03cccd54c08448005407d40b8cc04cd401088880114004048048d4010888800c0f80fc40fc4cd5ce2491e66756e6473206e6f742072657475726e656420746f2070726f706f7365720003e103e103e153355335330105001350042222004103f133573892011a70726f706f736572207369676e6174757265206d697373696e670003e1533553353335014501b3350153350163503c337006a0084444004900101f99a80c281d01f9aa800911111111111002881f899ab9c49116766f74696e6720706572696f64206e6f74206f7665720003e1533553353253353500322350022222222222223333500d25041250412504123335530351200150212350012253355335333573466e3cd400888008d4010880081481444ccd5cd19b873500222001350042200105205110511350450031504400d21333573466e20ccc044d4d400488004888800c0500500081001044c98c8108cd5ce2491473637269707420696e707574206d697373696e6700042350042222003103f133573892011c696e73756666696369656e742066756e647320696e207363726970740003e15335333573466e20ccc03cccd54c08448005407d40b8cc04cd401088880054004048048d4010888800c0f80fc40fc4cd5ce24912726563697069656e74206e6f7420706169640003e103e103e103e135001220023333573466e1cd55cea80224000466442466002006004646464646464646464646464646666ae68cdc39aab9d500c480008cccccccccccc88888888888848cccccccccccc00403403002c02802402001c01801401000c008cd40d40d8d5d0a80619a81a81b1aba1500b33503503735742a014666aa072eb940e0d5d0a804999aa81cbae503835742a01066a06a0866ae85401cccd540e4111d69aba150063232323333573466e1cd55cea80124000466a04c6464646666ae68cdc39aab9d5002480008cd40accd4139d69aba150023052357426ae8940088c98c8158cd5ce02b82b02a09aab9e5001137540026ae854008c8c8c8cccd5cd19b8735573aa0049000119a81699a8273ad35742a00460a46ae84d5d1280111931902b19ab9c057056054135573ca00226ea8004d5d09aba250022326320523357380a60a40a026aae7940044dd50009aba1500533503575c6ae854010ccd540e41008004d5d0a801999aa81cbae200135742a00460846ae84d5d1280111931902719ab9c04f04e04c135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d55cf280089baa00135742a00860646ae84d5d1280211931902019ab9c04104003e3333573466e1d40152002212200223333573466e1d40192000212200123263204033573808208007c07a6666ae68cdc39aab9d5009480008cccc888848cccc00401401000c008dd71aba15009375a6ae854020dd69aba15007375c6ae84d5d1280391931901f19ab9c03f03e03c103d16135573ca00226ea80044d55ce9baa001135744a00226ae8940044d55cf280089baa0012223232300100532001355039223350014800088d4008894cd4ccd5cd19b8f00200903a039130070011300600332001355038223350014800088d4008894cd4ccd5cd19b8f0020070390381001130060032235002222222222222533533355302312001500f25335333573466e3c0380040f80f44d40c4004540c0010840f840f04cd4054894cd40088400c4005408122100223500122222222222233355301c1200122350022222350042233500225335333573466e3c05c00410c1084cd40c40180204020802140a40284888d400888d400888d401488d4008894ccd4ccd404002c01800854cd400454cd40144ccd403802c00c01c40d44ccd403802c00c01c40d44ccd403802c00c01c48848cc00400c00848848cc00400c0084888d400888d400c894ccd4ccd402401c01000854cd400c400440bc40b840bc48848cc00400c0084888c8c8c8c94ccd4018854ccd4018854ccd402084c011261300349854ccd401c84c01126130034984038403054ccd401c84c011261300349854ccd401884c0112613003498403454ccd40148402c4030402854ccd4014854ccd401c84c015261300449854ccd401884c01526130044984034402c54ccd401884c015261300449854ccd401484c0152613004498403094ccd4014854ccd401c854ccd401c84ccd402c028008004585858403054ccd4018854ccd401884ccd4028024008004585858402c402894ccd4010854ccd4018854ccd401884ccd4028024008004585858402c54ccd4014854ccd401484ccd40240200080045858584028402494ccd400c854ccd4014854ccd401484ccd4024020008004585858402854ccd4010854ccd401084ccd402001c0080045858584024402094ccd4008854ccd4010854ccd401084ccd402001c008004585858402454ccd400c854ccd400c84ccd401c0180080045858584020401c48d40048888888801c448cccccccc00488ccd5cd19b87002001027026225335333573466e1c00800409c098401854cd4ccd5cd19b890020010270261004100522333573466e2000800409c09888ccd5cd19b8900200102702622333573466e2400800409809c88ccd5cd19b88002001026027225335333573466e2400800409c09840044008894cd4ccd5cd19b890020010270261002100112220031222002122200112233553007120012350012233550150023355300a12001235001223355018002333500123302d4800000488cc0b80080048cc0b400520000013355300712001235001223355015002333500123355300b1200123500122335501900235500d0010012233355500800f00200123355300b1200123500122335501900235500c00100133355500300a002001111222333553004120015010335530071200123500122335501500235500900133355300412001223500222533533355300c120013233500e223335003220020020013500122001123300122533500210291001026235001223300a00200500610031335014004003501100133553007120012350012232335501600330010053200135502a225335001135500a003221350022253353300c002008112223300200a0041300600300232001355023221122253350011002221330050023335530071200100500400111212223003004112122230010043200135502022112253350011500e22133500f300400233553006120010040013200135501f2211222533500113500322001221333500522002300400233355300712001005004001122123300100300222333573466e3c00800406806448c88c008dd6000990009aa80e911999aab9f0012500a233500930043574200460066ae880080708c8c8cccd5cd19b8735573aa004900011991091980080180118079aba150023005357426ae8940088c98c8070cd5ce00e80e00d09aab9e5001137540024646464646666ae68cdc39aab9d5004480008cccc888848cccc00401401000c008c8c8c8cccd5cd19b8735573aa0049000119910919800801801180c1aba15002335010017357426ae8940088c98c8084cd5ce01101080f89aab9e5001137540026ae854010ccd54021d728039aba150033232323333573466e1d4005200423212223002004357426aae79400c8cccd5cd19b875002480088c84888c004010dd71aba135573ca00846666ae68cdc3a801a400042444006464c6404666ae7009008c08408007c4d55cea80089baa00135742a00466a018eb8d5d09aba2500223263201d33573803c03a03626ae8940044d5d1280089aab9e500113754002266aa002eb9d6889119118011bab0013200135501a223233335573e0044a010466a00e66aa012600c6aae754008c014d55cf280118021aba200301a1357420022244004244244660020080062244246600200600424464646666ae68cdc3a800a400046a00e600a6ae84d55cf280191999ab9a3370ea00490011280391931900b99ab9c018017015014135573aa00226ea800448488c00800c44880048c8c8cccd5cd19b875001480188c848888c010014c01cd5d09aab9e500323333573466e1d400920042321222230020053009357426aae7940108cccd5cd19b875003480088c848888c004014c01cd5d09aab9e500523333573466e1d40112000232122223003005375c6ae84d55cf280311931900a99ab9c016015013012011010135573aa00226ea80048c8c8cccd5cd19b8735573aa004900011991091980080180118029aba15002375a6ae84d5d1280111931900899ab9c01201100f135573ca00226ea80048c8cccd5cd19b8735573aa002900011bae357426aae7940088c98c803ccd5ce00800780689baa001232323232323333573466e1d4005200c21222222200323333573466e1d4009200a21222222200423333573466e1d400d2008233221222222233001009008375c6ae854014dd69aba135744a00a46666ae68cdc3a8022400c4664424444444660040120106eb8d5d0a8039bae357426ae89401c8cccd5cd19b875005480108cc8848888888cc018024020c030d5d0a8049bae357426ae8940248cccd5cd19b875006480088c848888888c01c020c034d5d09aab9e500b23333573466e1d401d2000232122222223005008300e357426aae7940308c98c8060cd5ce00c80c00b00a80a00980900880809aab9d5004135573ca00626aae7940084d55cf280089baa0012323232323333573466e1d400520022333222122333001005004003375a6ae854010dd69aba15003375a6ae84d5d1280191999ab9a3370ea0049000119091180100198041aba135573ca00c464c6402266ae7004804403c0384d55cea80189aba25001135573ca00226ea80048c8c8cccd5cd19b875001480088c8488c00400cdd71aba135573ca00646666ae68cdc3a8012400046424460040066eb8d5d09aab9e500423263200e33573801e01c01801626aae7540044dd500089119191999ab9a3370ea00290021280311999ab9a3370ea004900111a80498031aba135573ca00846666ae68cdc3a801a40004a012464c6401e66ae7004003c03403002c4d55cea80089baa001121222300300411222002112220012323333573466e1d40052002200523333573466e1d40092000200523263200833573801201000c00a26aae74dd5000891001091000a4c240029210350543100223370000400222464600200244660066004004003";

const script = {
  type: "PlutusV2",
  script: CLIMATE_DAO_VALIDATOR,
};

/* ===============================
   INIT LUCID
   =============================== */
export async function initLucid() {
  try {
    lucid = await Lucid.new(
      new Blockfrost(
        "https://cardano-preprod.blockfrost.io/api/v0",
        "preprodYjRkHfcazNkL0xxG9C2RdUbUoTrG7wip"
      ),
      "Preprod"
    );

    const api = await window.cardano.lace.enable();
    lucid.selectWallet(api);

    walletAddress = await lucid.wallet.address();
    scriptAddress = lucid.utils.validatorToAddress(script);

    console.log("Connected wallet:", walletAddress);
    console.log("Script address:", scriptAddress);

    // Update UI
    const walletInfoEl = document.getElementById("walletInfo");
    const walletAddressEl = document.getElementById("walletAddress");
    if (walletInfoEl && walletAddressEl) {
      walletAddressEl.textContent = walletAddress;
      walletInfoEl.classList.remove("hidden");
    }

    // Auto-fill recipient with your address for testing
    const recipientInput = document.getElementById("recipient");
    if (recipientInput && !recipientInput.value) {
      recipientInput.value = walletAddress;
    }

    document.getElementById("app").classList.remove("hidden");
    log("‚úÖ Wallet connected successfully!");
    log(`üìç Script address: ${scriptAddress}`);
  } catch (error) {
    console.error("‚ùå Wallet connection error:", error);
    log(`‚ùå Error: ${error.message}`);
    throw error;
  }
}

/* ===============================
   DATUM: ProposalDatum
   { proposer, fundingGoal, votingDeadline, recipient }
=============================== */
function mkProposalDatum(proposerPkh, fundingGoal, votingDeadline, recipientPkh) {
  return Data.to(
    new Constr(0, [
      proposerPkh,
      BigInt(fundingGoal),
      BigInt(votingDeadline),
      recipientPkh,
    ])
  );
}

/* ===============================
   REDEEMERS: TreasuryAction
=============================== */
function redeemerFundProposal() {
  return Data.to(new Constr(0, [])); // FundProposal
}

function redeemerCancelProposal() {
  return Data.to(new Constr(1, [])); // CancelProposal
}

/* ===============================
   ADDRESS VALIDATION
=============================== */
function validateAndExtractPkh(address) {
  try {
    const addressDetails = lucid.utils.getAddressDetails(address);
    
    if (!addressDetails.paymentCredential) {
      throw new Error("Invalid address: No payment credential found");
    }
    
    return addressDetails.paymentCredential.hash;
  } catch (error) {
    console.error("Address validation error:", error);
    throw new Error(`Invalid Cardano address: ${error.message}`);
  }
}

/* ===============================
   CREATE PROPOSAL
=============================== */
export async function createProposal() {
  try {
    const fundingGoalAda = document.getElementById("fundingGoal").value;
    const votingDeadline = document.getElementById("votingDeadline").value;
    const recipientAddr = document.getElementById("recipient").value;

    log("üìù Validating inputs...");

    if (!fundingGoalAda || parseFloat(fundingGoalAda) < 1) {
      throw new Error("Funding goal must be at least 1 ADA");
    }
    
    if (!votingDeadline || votingDeadline.trim() === "") {
      throw new Error("Voting deadline is required - Click a button to set it!");
    }
    
    if (!recipientAddr || recipientAddr.trim() === "") {
      throw new Error("Recipient address is required");
    }

    const fundingGoal = BigInt(Math.floor(parseFloat(fundingGoalAda) * 1_000_000));
    const deadline = BigInt(votingDeadline);

    const proposerPkh = lucid.utils.getAddressDetails(walletAddress).paymentCredential.hash;
    const recipientPkh = validateAndExtractPkh(recipientAddr);

    log(`üìã Creating proposal: ${fundingGoalAda} ADA until ${new Date(Number(deadline)).toLocaleString()}`);

    const datum = mkProposalDatum(proposerPkh, fundingGoal, deadline, recipientPkh);

    log("üî® Building transaction...");

    const tx = await lucid
      .newTx()
      .payToContract(scriptAddress, { inline: datum }, { lovelace: fundingGoal })
      .addSignerKey(proposerPkh)
      .complete();

    log("‚úçÔ∏è Signing transaction...");
    const signed = await tx.sign().complete();
    
    log("üì§ Submitting to blockchain...");
    const txHash = await signed.submit();

    console.log("‚úÖ Proposal created TX:", txHash);
    log(`‚úÖ SUCCESS! Proposal created!`);
    log(`TX: ${txHash}`);
    log(`Explorer: https://preprod.cardanoscan.io/transaction/${txHash}`);
    
    if (window.setProposalDeadline) {
      window.setProposalDeadline(votingDeadline);
    }
    
    return txHash;
  } catch (error) {
    console.error("‚ùå Error creating proposal:", error);
    log(`‚ùå ERROR: ${error.message}`);
    throw error;
  }
}

/* ===============================
   CANCEL PROPOSAL
=============================== */
export async function cancelProposal() {
  try {
    const proposerPkh =
      lucid.utils.getAddressDetails(walletAddress).paymentCredential.hash;

    log("üîç Searching for YOUR proposals...");

    const utxos = await lucid.utxosAt(scriptAddress);

    let myProposals = [];

    for (const utxo of utxos) {
      try {
        const datumData = Data.from(utxo.datum);
        const datumProposer = datumData.fields[0];

        if (datumProposer === proposerPkh) {
          myProposals.push({ utxo, datumData });
        }
      } catch (_) {}
    }

    if (myProposals.length === 0) {
      throw new Error("No proposals created by your wallet.");
    }

    // In cancelProposal function - this code correctly filters
const now = Date.now();

// ‚úÖ KEEP ONLY ACTIVE PROPOSALS
const activeProposals = myProposals.filter(p =>
  now < Number(p.datumData.fields[2])
);

if (activeProposals.length === 0) {
  throw new Error("All your proposals have expired. Use Release Funds.");
}

    // ‚úÖ PICK THE MOST RECENT ONE
    activeProposals.sort(
      (a, b) =>
        Number(b.datumData.fields[2]) - Number(a.datumData.fields[2])
    );

    const { utxo: targetUtxo, datumData } = activeProposals[0];

    const deadline = Number(datumData.fields[2]);

    log(`‚è∞ ${Math.floor((deadline - now) / 1000)}s remaining`);
    log("üî® Building cancellation transaction...");

    const tx = await lucid
      .newTx()
      .collectFrom([targetUtxo], redeemerCancelProposal())
      .payToAddress(walletAddress, { lovelace: targetUtxo.assets.lovelace })
      .attachSpendingValidator(script)
      .addSignerKey(proposerPkh)
      .validFrom(now)
      .validTo(deadline - 1)
      .complete();

    const signed = await tx.sign().complete();
    const txHash = await signed.submit();

    log(`‚úÖ Proposal cancelled`);
    log(`TX: ${txHash}`);

    return txHash;
  } catch (error) {
    log(`‚ùå ERROR: ${error.message}`);
    throw error;
  }
}
/* ===============================
   RELEASE FUNDS
=============================== */
export async function releaseFunds() {
  try {
    const proposerPkh =
      lucid.utils.getAddressDetails(walletAddress).paymentCredential.hash;

    log("üîç Searching for YOUR proposals...");

    const utxos = await lucid.utxosAt(scriptAddress);

    let myProposals = [];

    for (const utxo of utxos) {
      try {
        const datumData = Data.from(utxo.datum);
        const datumProposer = datumData.fields[0];

        if (datumProposer === proposerPkh) {
          myProposals.push({ utxo, datumData });
        }
      } catch (_) {}
    }

    if (myProposals.length === 0) {
      throw new Error("No proposals created by your wallet.");
    }

    const now = Date.now();

    // ‚úÖ KEEP ONLY EXPIRED PROPOSALS
    const expiredProposals = myProposals.filter(p =>
      now >= Number(p.datumData.fields[2])
    );

    if (expiredProposals.length === 0) {
      throw new Error("No proposals eligible for release yet.");
    }

    // ‚úÖ PICK MOST RECENT EXPIRED
    expiredProposals.sort(
      (a, b) =>
        Number(b.datumData.fields[2]) - Number(a.datumData.fields[2])
    );

    const { utxo: targetUtxo, datumData } = expiredProposals[0];

    const recipientPkh = datumData.fields[3];
    const deadline = Number(datumData.fields[2]);

    const recipientAddress = lucid.utils.credentialToAddress({
      type: "Key",
      hash: recipientPkh,
    });

    log("üî® Building release transaction...");

    const tx = await lucid
      .newTx()
      .collectFrom([targetUtxo], redeemerFundProposal())
      .payToAddress(recipientAddress, {
        lovelace: targetUtxo.assets.lovelace,
      })
      .attachSpendingValidator(script)
      .addSignerKey(proposerPkh)
      .validFrom(deadline + 1)
      .complete();

    const signed = await tx.sign().complete();
    const txHash = await signed.submit();

    log(`‚úÖ Funds released`);
    log(`TX: ${txHash}`);

    return txHash;
  } catch (error) {
    log(`‚ùå ERROR: ${error.message}`);
    throw error;
  }
}

/* ===============================
   LOGGING
=============================== */
function log(msg) {
  const logEl = document.getElementById("log");
  if (logEl) {
    const timestamp = new Date().toLocaleTimeString();
    logEl.textContent = `[${timestamp}] ${msg}\n${logEl.textContent}`;
  }
  console.log(msg);
}

window.log = log;

/* ===============================
   EVENT HANDLERS
=============================== */
document.getElementById("connectWallet")?.addEventListener("click", initLucid);
document.getElementById("createBtn")?.addEventListener("click", createProposal);
document.getElementById("cancelBtn")?.addEventListener("click", cancelProposal);
document.getElementById("releaseBtn")?.addEventListener("click", releaseFunds);import {
  Lucid,
  Blockfrost,
  Constr,
  Data,
} from "https://unpkg.com/lucid-cardano@0.10.11/web/mod.js";

let lucid;
let walletAddress;
let scriptAddress;

/* ===============================
   PLUTUS V2 VALIDATOR (CBOR HEX)
   =============================== */
const TREASURY_VALIDATOR_CBOR = "590fe701000032323232323322323332223232323232323233223232332232323232323332223232323232323232323232323232323233223232323223232323223232232325335323232325335003153355335330195001350042222004104013357389211a70726f706f736572207369676e6174757265206d697373696e670003f153355335333501e502533501f335020503c0403350223503d3500422220020403550012222222222220051040133573892011b63616e63656c6c6174696f6e20706572696f6420656c61707365640003f15335333573466e20ccc060ccd54c04c48005404540bccc040d401088880114004074074d4010888800c0fc10041004cd5ce2491e66756e6473206e6f742072657475726e656420746f2070726f706f7365720003f103f103f21533553353301a5002350052222004104113357389211a70726f706f736572207369676e6174757265206d697373696e6700040153355335333501f50263350203350213503e337006a00a4444004900102099a811a81e0209aa8011111111111110028820899ab9c49116766f74696e6720706572696f64206e6f74206f766572000401533553353253353500422350022222222222223333500d250432504325043233355302b12001502c2350012253355335333573466e3cd400888008d40108800815014c4ccd5cd19b873500222001350042200105405310531350470031504600d21333573466e20ccc06cd4d400488004888800c08008000810810c4c98c8110cd5ce2491a6e6f20696e7075742066726f6d2073637269707420666f756e64000443500522220031041133573892011c696e73756666696369656e742066756e647320696e2073637269707400040153355335333573466e3c004d4014888800410410041044cd5ce2491b72656465656d657220726563697069656e74206d69736d617463680004015335333573466e20ccc064c8ccd54c05448005404d40c4cc0480080054008078078d4014888800c10010441044cd5ce24912726563697069656e74206e6f742070616964000401040104010401040135001220023333573466e1cd55cea80224000466442466002006004646464646464646464646464646666ae68cdc39aab9d500c480008cccccccccccc88888888888848cccccccccccc00403403002c02802402001c01801401000c008cd40d80dcd5d0a80619a81b01b9aba1500b33503603835742a014666aa074eb940e4d5d0a804999aa81d3ae503935742a01066a06c0886ae85401cccd540e8115d69aba150063232323333573466e1cd55cea80124000466a0606464646666ae68cdc39aab9d5002480008cd40d4cd413dd69aba150023053357426ae8940088c98c815ccd5ce02c02b82a89aab9e5001137540026ae854008c8c8c8cccd5cd19b8735573aa0049000119a81b99a827bad35742a00460a66ae84d5d1280111931902b99ab9c058057055135573ca00226ea8004d5d09aba250022326320533357380a80a60a226aae7940044dd50009aba1500533503675c6ae854010ccd540e81048004d5d0a801999aa81d3ae200135742a00460866ae84d5d1280111931902799ab9c05004f04d135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d55cf280089baa00135742a00860666ae84d5d1280211931902099ab9c04204103f3333573466e1d40152002212200223333573466e1d401920002321223001003375c6ae84d55cf280411931902099ab9c04204103f03e3333573466e1cd55cea8052400046666444424666600200a0080060046eb8d5d0a8051bad35742a0126eb4d5d0a8041bae357426ae8940208c98c80fccd5ce02001f81e881f0b09aab9e50011375400226aae7540044dd500089aba25001135744a00226aae7940044dd5000911a800911111111111199aa980889000911a80111111a8021119a8011299a999ab9a3371e02e00208e08c266a06a00c01020104010a05a01424466aa600e2400246a0024466aa04800466aa60142400246a0024466aa04e004666a0024660789000000911981e80100091981e000a400000266aa600e2400246a0024466aa048004666a002466aa60162400246a0024466aa0500046aa01a00200244666aaa01001a004002466aa60162400246a0024466aa0500046aa018002002666aaa006010004002222444666aa600824002a03e66aa600e2400246a0024466aa0480046aa012002666aa600824002446a00444a66a666aa601e240026466a02444666a006440040040026a00244002246600244a66a0042070200206a46a002446601400400a00c2006266a046008006a04000266aa600e2400246a002446466aa04a006600200a640026aa07244a66a00226aa0140064426a00444a66a6601800401022444660040140082600c006004640026aa0644422444a66a00220044426600a004666aa600e2400200a0080022242444600600822424446002008640026aa05e442244a66a0022a03a44266a03c600800466aa600c2400200800244666ae68cdc780100081581511119191800802990009aa8189119a800a4000446a00444a66a666ae68cdc78010048190188980380089803001990009aa8181119a800a4000446a00444a66a666ae68cdc7801003818818080089803001911a801111111111111299a999aa980789000a8081299a999ab9a3371e01c00206c06a26a0520022a0500084206c2068640026aa0564422444a66a00226a00644002442666a00a440046008004666aa600e2400200a008002266a00244a66a004420062002a02e24424660020060049101001222350022235002223500522350022253335333501000b00600215335001153350051333500e00b003007102c1333500e00b003007102c1333500e00b00300712212330010030021221233001003002122235002223500322533353335009007004002153350031001102610251026122123300100300212223232323253335006215333500621533350082130044984c00d261533350072130044984c00d26100e100c1533350072130044984c00d261533350062130044984c00d26100d1533350052100b100c100a15333500521533350072130054984c011261533350062130054984c01126100d100b1533350062130054984c011261533350052130054984c01126100c2533350052153335007215333500721333500b00a002001161616100c153335006215333500621333500a009002001161616100b100a2533350042153335006215333500621333500a009002001161616100b1533350052153335005213335009008002001161616100a100925333500321533350052153335005213335009008002001161616100a1533350042153335004213335008007002001161616100910082533350022153335004215333500421333500800700200116161610091533350032153335003213335007006002001161616100810071235001222222220071123333333300122333573466e1c008004078074894cd4ccd5cd19b8700200101e01d100615335333573466e240080040780744010401488ccd5cd19b8800200101e01d22333573466e2400800407807488ccd5cd19b8900200101d01e22333573466e20008004074078894cd4ccd5cd19b8900200101e01d10011002225335333573466e2400800407807440084004488800c4888008488800448c88c008dd6000990009aa80e911999aab9f0012500a233500930043574200460066ae880080708c8c8cccd5cd19b8735573aa004900011991091980080180118079aba150023005357426ae8940088c98c8070cd5ce00e80e00d09aab9e5001137540024646464646666ae68cdc39aab9d5004480008cccc888848cccc00401401000c008c8c8c8cccd5cd19b8735573aa0049000119910919800801801180c1aba15002335010017357426ae8940088c98c8084cd5ce01101080f89aab9e5001137540026ae854010ccd54021d728039aba150033232323333573466e1d4005200423212223002004357426aae79400c8cccd5cd19b875002480088c84888c004010dd71aba135573ca00846666ae68cdc3a801a400042444006464c6404666ae7009008c08408007c4d55cea80089baa00135742a00466a018eb8d5d09aba2500223263201d33573803c03a03626ae8940044d5d1280089aab9e500113754002266aa002eb9d6889119118011bab0013200135501a223233335573e0044a010466a00e66aa012600c6aae754008c014d55cf280118021aba200301a1357420022244004244244660020080062244246600200600424464646666ae68cdc3a800a400046a00e600a6ae84d55cf280191999ab9a3370ea00490011280391931900b99ab9c018017015014135573aa00226ea800448488c00800c44880048c8c8cccd5cd19b875001480188c848888c010014c01cd5d09aab9e500323333573466e1d400920042321222230020053009357426aae7940108cccd5cd19b875003480088c848888c004014c01cd5d09aab9e500523333573466e1d40112000232122223003005375c6ae84d55cf280311931900a99ab9c016015013012011010135573aa00226ea80048c8c8cccd5cd19b8735573aa004900011991091980080180118029aba15002375a6ae84d5d1280111931900899ab9c01201100f135573ca00226ea80048c8cccd5cd19b8735573aa002900011bae357426aae7940088c98c803ccd5ce00800780689baa001232323232323333573466e1d4005200c21222222200323333573466e1d4009200a21222222200423333573466e1d400d2008233221222222233001009008375c6ae854014dd69aba135744a00a46666ae68cdc3a8022400c4664424444444660040120106eb8d5d0a8039bae357426ae89401c8cccd5cd19b875005480108cc8848888888cc018024020c030d5d0a8049bae357426ae8940248cccd5cd19b875006480088c848888888c01c020c034d5d09aab9e500b23333573466e1d401d2000232122222223005008300e357426aae7940308c98c8060cd5ce00c80c00b00a80a00980900880809aab9d5004135573ca00626aae7940084d55cf280089baa0012323232323333573466e1d400520022333222122333001005004003375a6ae854010dd69aba15003375a6ae84d5d1280191999ab9a3370ea0049000119091180100198041aba135573ca00c464c6402266ae7004804403c0384d55cea80189aba25001135573ca00226ea80048c8c8cccd5cd19b875001480088c8488c00400cdd71aba135573ca00646666ae68cdc3a8012400046424460040066eb8d5d09aab9e500423263200e33573801e01c01801626aae7540044dd500089119191999ab9a3370ea00290021280311999ab9a3370ea004900111a80498031aba135573ca00846666ae68cdc3a801a40004a012464c6401e66ae7004003c03403002c4d55cea80089baa001121222300300411222002112220012323333573466e1d40052002200523333573466e1d40092000200523263200833573801201000c00a26aae74dd5000891001091000a4c240029210350543100223370000400222464600200244660066004004003";

const script = {
  type: "PlutusV2",
  script: TREASURY_VALIDATOR_CBOR,
};

/* ===============================
   INIT LUCID
   =============================== */
export async function initLucid() {
  lucid = await Lucid.new(
    new Blockfrost(
      "https://cardano-preprod.blockfrost.io/api/v0",
      "preprodYjRkHfcazNkL0xxG9C2RdUbUoTrG7wip"
    ),
    "Preprod"
  );

  const api = await window.cardano.lace.enable();
  lucid.selectWallet(api);

  walletAddress = await lucid.wallet.address();
  scriptAddress = lucid.utils.validatorToAddress(script);

  console.log("Connected wallet:", walletAddress);
  console.log("Script address:", scriptAddress);

  document.getElementById("app").classList.remove("hidden");
}

/* ===============================
   DATUM
   ProposalDatum:
   { proposer, fundingGoal, votingDeadline, recipient }
=============================== */
function mkProposalDatum(proposer, fundingGoal, votingDeadline, recipient) {
  return Data.to(
    new Constr(0, [
      proposer,
      BigInt(fundingGoal),
      BigInt(votingDeadline),
      recipient,
    ])
  );
}

/* ===============================
   REDEEMERS
   TreasuryAction
=============================== */
function redeemerFundProposal() {
  return Data.to(new Constr(0, [])); // FundProposal takes no extra args
}
function redeemerCancelProposal() {
  return Data.to(new Constr(1, [])); // CancelProposal takes no extra args
}

/* ===============================
   FUND PROPOSAL
=============================== */
export async function fundProposal() {
  const fundingGoal = BigInt(document.getElementById("fundingGoal").value) * 1_000_000n;
  const votingDeadline = BigInt(document.getElementById("votingDeadline").value);
  const recipientAddr = document.getElementById("recipient").value;

  const proposerPkh = lucid.utils.getAddressDetails(walletAddress).paymentCredential.hash;

  const datum = mkProposalDatum(proposerPkh, fundingGoal, votingDeadline, recipientAddr);

  const tx = await lucid
    .newTx()
    .payToContract(scriptAddress, { inline: datum }, { lovelace: fundingGoal })
    .complete();

  const signed = await tx.sign().complete();
  const txHash = await signed.submit();

  console.log("FundProposal TX:", txHash);
}

/* ===============================
   CANCEL PROPOSAL
=============================== */
export async function cancelProposal() {
  const proposerPkh = lucid.utils.getAddressDetails(walletAddress).paymentCredential.hash;

  // Grab UTXOs at script
  const utxos = await lucid.utxosAt(scriptAddress);

  if (utxos.length === 0) return console.log("No proposals to cancel");

  const targetUtxo = utxos[0]; // Simplified: first proposal

  const datum = Data.from(targetUtxo.datum);

  const tx = await lucid
    .newTx()
    .collectFrom([targetUtxo], redeemerCancelProposal())
    .payToAddress(walletAddress, { lovelace: targetUtxo.assets.lovelace })
    .attachSpendingValidator(script)
    .addSignerKey(proposerPkh)
    .complete();

  const signed = await tx.sign().complete();
  const txHash = await signed.submit();

  console.log("CancelProposal TX:", txHash);
}

/* ===============================
   UI LOGGING
=============================== */
export function log(msg) {
  document.getElementById("log").innerText = msg;
}

// Event handlers
document.getElementById("connectWallet").onclick = initLucid;
document.getElementById("fundBtn").onclick = fundProposal;
document.getElementById("cancelBtn").onclick = cancelProposal;
