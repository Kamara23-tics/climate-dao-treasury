<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Climate DAO Treasury</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .header h1 { color: #667eea; font-size: 2.5em; margin-bottom: 10px; }
        .header p { color: #666; font-size: 1.1em; }
        .wallet-section {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .wallet-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .status-info { flex: 1; min-width: 200px; }
        .status-label { font-size: 0.9em; color: #666; margin-bottom: 5px; }
        .status-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            word-break: break-all;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }
        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary { background: #48bb78; }
        .btn-secondary:hover { background: #38a169; }
        .btn-danger { background: #f56565; }
        .btn-danger:hover { background: #e53e3e; }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .card h2 { color: #667eea; margin-bottom: 20px; font-size: 1.5em; }
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            transition: border 0.3s;
        }
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-group small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 0.85em;
        }
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border: 2px solid #48bb78;
        }
        .alert-error {
            background: #fed7d7;
            color: #742a2a;
            border: 2px solid #f56565;
        }
        .alert-info {
            background: #bee3f8;
            color: #2c5282;
            border: 2px solid #4299e1;
        }
        .script-info {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .script-info h3 { color: #667eea; margin-bottom: 15px; }
        .info-item {
            margin-bottom: 15px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
        }
        .info-label { font-weight: 600; color: #333; margin-bottom: 5px; }
        .info-value {
            color: #666;
            font-family: monospace;
            font-size: 0.9em;
            word-break: break-all;
        }
        .hidden { display: none; }
        #log {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 0.9em;
            color: #333;
            min-height: 40px;
        }
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8em; }
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå± Climate DAO Treasury</h1>
            <p>Decentralized funding for climate action projects</p>
        </div>

        <div class="wallet-section">
            <div class="wallet-status">
                <div class="status-info">
                    <div class="status-label">Wallet Status</div>
                    <div class="status-value" id="walletStatus">Not Connected</div>
                </div>
                <div class="status-info">
                    <div class="status-label">Balance</div>
                    <div class="status-value" id="walletBalance">0 ADA</div>
                </div>
                <button class="btn" id="connectWallet">Connect Wallet</button>
            </div>
        </div>

        <div id="alertContainer"></div>

        <div id="app" class="hidden">
            <div class="script-info">
                <h3>Smart Contract Information</h3>
                <div class="info-item">
                    <div class="info-label">Script Address (Preprod)</div>
                    <div class="info-value" id="scriptAddress">Loading...</div>
                </div>
            </div>

            <div class="grid">
                <div class="card">
                    <h2>Create Proposal</h2>
                    <div class="form-group">
                        <label>Funding Goal (ADA)</label>
                        <input type="number" id="fundingGoal" placeholder="1000" min="1" step="0.001" required>
                        <small>Amount needed for the project (minimum 1 ADA)</small>
                    </div>
                    <div class="form-group">
                        <label>Voting Deadline (POSIX Time in milliseconds)</label>
                        <input type="number" id="votingDeadline" placeholder="1735689600000">
                        <small>
                            <strong>Leave empty for 4 months from now</strong><br>
                            Current time: <span id="currentTime"></span><br>
                            Or use: <button type="button" class="btn" style="padding: 4px 8px; font-size: 0.85em;" onclick="setFourMonthsDeadline()">Set 4 Months</button>
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Recipient Public Key Hash</label>
                        <input type="text" id="recipient" placeholder="Leave empty to use your PKH">
                        <small>Who will receive the funds (leave empty to use your PKH)</small>
                    </div>
                    <button class="btn btn-secondary" id="fundBtn">Create Proposal</button>
                    <div id="log"></div>
                </div>

                <div class="card">
                    <h2>Cancel Proposal</h2>
                    <p style="margin-bottom: 20px; color: #666;">
                        This will cancel the first proposal found at the script address and return funds to your wallet.
                    </p>
                    <button class="btn btn-danger" id="cancelBtn">Cancel First Proposal</button>
                    <div style="margin-top: 15px; padding: 15px; background: #fff5f5; border-radius: 8px; border: 2px solid #feb2b2;">
                        <strong style="color: #c53030;">‚ö†Ô∏è Important:</strong>
                        <ul style="margin-top: 10px; color: #742a2a; padding-left: 20px;">
                            <li>Only works before voting deadline</li>
                            <li>Must be signed by the proposer</li>
                            <li>Returns funds to your wallet</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import {
            Lucid,
            Blockfrost,
            Constr,
            Data,
        } from "https://unpkg.com/lucid-cardano@0.10.11/web/mod.js";

        let lucid;
        let walletAddress;
        let scriptAddress;

        const TREASURY_VALIDATOR_CBOR = "590fe701000032323232323322323332223232323232323233223232332232323232323332223232323232323232323232323232323233223232323223232323223232232325335323232325335003153355335330195001350042222004104013357389211a70726f706f736572207369676e6174757265206d697373696e670003f153355335333501e502533501f335020503c0403350223503d3500422220020403550012222222222220051040133573892011b63616e63656c6c6174696f6e20706572696f6420656c61707365640003f15335333573466e20ccc060ccd54c04c48005404540bccc040d401088880114004074074d4010888800c0fc10041004cd5ce2491e66756e6473206e6f742072657475726e656420746f2070726f706f7365720003f103f103f21533553353301a5002350052222004104113357389211a70726f706f736572207369676e6174757265206d697373696e6700040153355335333501f50263350203350213503e337006a00a4444004900102099a811a81e0209aa8011111111111110028820899ab9c49116766f74696e6720706572696f64206e6f74206f766572000401533553353253353500422350022222222222223333500d250432504325043233355302b12001502c2350012253355335333573466e3cd400888008d40108800815014c4ccd5cd19b873500222001350042200105405310531350470031504600d21333573466e20ccc06cd4d400488004888800c08008000810810c4c98c8110cd5ce2491a6e6f20696e7075742066726f6d2073637269707420666f756e64000443500522220031041133573892011c696e73756666696369656e742066756e647320696e2073637269707400040153355335333573466e3c004d4014888800410410041044cd5ce2491b72656465656d657220726563697069656e74206d69736d617463680004015335333573466e20ccc064c8ccd54c05448005404d40c4cc0480080054008078078d4014888800c10010441044cd5ce24912726563697069656e74206e6f742070616964000401040104010401040135001220023333573466e1cd55cea80224000466442466002006004646464646464646464646464646666ae68cdc39aab9d500c480008cccccccccccc88888888888848cccccccccccc00403403002c02802402001c01801401000c008cd40d80dcd5d0a80619a81b01b9aba1500b33503603835742a014666aa074eb940e4d5d0a804999aa81d3ae503935742a01066a06c0886ae85401cccd540e8115d69aba150063232323333573466e1cd55cea80124000466a0606464646666ae68cdc39aab9d5002480008cd40d4cd413dd69aba150023053357426ae8940088c98c815ccd5ce02c02b82a89aab9e5001137540026ae854008c8c8c8cccd5cd19b8735573aa0049000119a81b99a827bad35742a00460a66ae84d5d1280111931902b99ab9c058057055135573ca00226ea8004d5d09aba250022326320533357380a80a60a226aae7940044dd50009aba1500533503675c6ae854010ccd540e81048004d5d0a801999aa81d3ae200135742a00460866ae84d5d1280111931902799ab9c05004f04d135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d55cf280089baa00135742a00860666ae84d5d1280211931902099ab9c04204103f3333573466e1d40152002212200223333573466e1d401920002321223001003375c6ae84d55cf280411931902099ab9c04204103f03e3333573466e1cd55cea8052400046666444424666600200a0080060046eb8d5d0a8051bad35742a0126eb4d5d0a8041bae357426ae8940208c98c80fccd5ce02001f81e881f0b09aab9e50011375400226aae7540044dd500089aba25001135744a00226aae7940044dd5000911a800911111111111199aa980889000911a80111111a8021119a8011299a999ab9a3371e02e00208e08c266a06a00c01020104010a05a01424466aa600e2400246a0024466aa04800466aa60142400246a0024466aa04e004666a0024660789000000911981e80100091981e000a400000266aa600e2400246a0024466aa048004666a002466aa60162400246a0024466aa0500046aa01a00200244666aaa01001a004002466aa60162400246a0024466aa0500046aa018002002666aaa006010004002222444666aa600824002a03e66aa600e2400246a0024466aa0480046aa012002666aa600824002446a00444a66a666aa601e240026466a02444666a006440040040026a00244002246600244a66a0042070200206a46a002446601400400a00c2006266a046008006a04000266aa600e2400246a002446466aa04a006600200a640026aa07244a66a00226aa0140064426a00444a66a6601800401022444660040140082600c006004640026aa0644422444a66a00220044426600a004666aa600e2400200a0080022242444600600822424446002008640026aa05e442244a66a0022a03a44266a03c600800466aa600c2400200800244666ae68cdc780100081581511119191800802990009aa8189119a800a4000446a00444a66a666ae68cdc78010048190188980380089803001990009aa8181119a800a4000446a00444a66a666ae68cdc7801003818818080089803001911a801111111111111299a999aa980789000a8081299a999ab9a3371e01c00206c06a26a0520022a0500084206c2068640026aa0564422444a66a00226a00644002442666a00a440046008004666aa600e2400200a008002266a00244a66a004420062002a02e24424660020060049101001222350022235002223500522350022253335333501000b00600215335001153350051333500e00b003007102c1333500e00b003007102c1333500e00b00300712212330010030021221233001003002122235002223500322533353335009007004002153350031001102610251026122123300100300212223232323253335006215333500621533350082130044984c00d261533350072130044984c00d26100e100c1533350072130044984c00d261533350062130044984c00d26100d1533350052100b100c100a15333500521533350072130054984c011261533350062130054984c01126100d100b1533350062130054984c011261533350052130054984c01126100c2533350052153335007215333500721333500b00a002001161616100c153335006215333500621333500a009002001161616100b100a2533350042153335006215333500621333500a009002001161616100b1533350052153335005213335009008002001161616100a100925333500321533350052153335005213335009008002001161616100a1533350042153335004213335008007002001161616100910082533350022153335004215333500421333500800700200116161610091533350032153335003213335007006002001161616100810071235001222222220071123333333300122333573466e1c008004078074894cd4ccd5cd19b8700200101e01d100615335333573466e240080040780744010401488ccd5cd19b8800200101e01d22333573466e2400800407807488ccd5cd19b8900200101d01e22333573466e20008004074078894cd4ccd5cd19b8900200101e01d10011002225335333573466e2400800407807440084004488800c4888008488800448c88c008dd6000990009aa80e911999aab9f0012500a233500930043574200460066ae880080708c8c8cccd5cd19b8735573aa004900011991091980080180118079aba150023005357426ae8940088c98c8070cd5ce00e80e00d09aab9e5001137540024646464646666ae68cdc39aab9d5004480008cccc888848cccc00401401000c008c8c8c8cccd5cd19b8735573aa0049000119910919800801801180c1aba15002335010017357426ae8940088c98c8084cd5ce01101080f89aab9e5001137540026ae854010ccd54021d728039aba150033232323333573466e1d4005200423212223002004357426aae79400c8cccd5cd19b875002480088c84888c004010dd71aba135573ca00846666ae68cdc3a801a400042444006464c6404666ae7009008c08408007c4d55cea80089baa00135742a00466a018eb8d5d09aba2500223263201d33573803c03a03626ae8940044d5d1280089aab9e500113754002266aa002eb9d6889119118011bab0013200135501a223233335573e0044a010466a00e66aa012600c6aae754008c014d55cf280118021aba200301a1357420022244004244244660020080062244246600200600424464646666ae68cdc3a800a400046a00e600a6ae84d55cf280191999ab9a3370ea00490011280391931900b99ab9c018017015014135573aa00226ea800448488c00800c44880048c8c8cccd5cd19b875001480188c848888c010014c01cd5d09aab9e500323333573466e1d400920042321222230020053009357426aae7940108cccd5cd19b875003480088c848888c004014c01cd5d09aab9e500523333573466e1d40112000232122223003005375c6ae84d55cf280311931900a99ab9c016015013012011010135573aa00226ea80048c8c8cccd5cd19b8735573aa004900011991091980080180118029aba15002375a6ae84d5d1280111931900899ab9c01201100f135573ca00226ea80048c8cccd5cd19b8735573aa002900011bae357426aae7940088c98c803ccd5ce00800780689baa001232323232323333573466e1d4005200c21222222200323333573466e1d4009200a21222222200423333573466e1d400d2008233221222222233001009008375c6ae854014dd69aba135744a00a46666ae68cdc3a8022400c4664424444444660040120106eb8d5d0a8039bae357426ae89401c8cccd5cd19b875005480108cc8848888888cc018024020c030d5d0a8049bae357426ae8940248cccd5cd19b875006480088c848888888c01c020c034d5d09aab9e500b23333573466e1d401d2000232122222223005008300e357426aae7940308c98c8060cd5ce00c80c00b00a80a00980900880809aab9d5004135573ca00626aae7940084d55cf280089baa0012323232323333573466e1d400520022333222122333001005004003375a6ae854010dd69aba15003375a6ae84d5d1280191999ab9a3370ea0049000119091180100198041aba135573ca00c464c6402266ae7004804403c0384d55cea80189aba25001135573ca00226ea80048c8c8cccd5cd19b875001480088c8488c00400cdd71aba135573ca00646666ae68cdc3a8012400046424460040066eb8d5d09aab9e500423263200e33573801e01c01801626aae7540044dd500089119191999ab9a3370ea00290021280311999ab9a3370ea004900111a80498031aba135573ca00846666ae68cdc3a801a40004a012464c6401e66ae7004003c03403002c4d55cea80089baa001121222300300411222002112220012323333573466e1d40052002200523333573466e1d40092000200523263200833573801201000c00a26aae74dd5000891001091000a4c240029210350543100223370000400222464600200244660066004004003";

        const script = {
            type: "PlutusV2",
            script: TREASURY_VALIDATOR_CBOR,
        };

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertContainer.innerHTML = '';
            alertContainer.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        function log(msg) {
            document.getElementById("log").innerText = msg;
        }

        async function initLucid() {
            try {
                showAlert('Connecting to wallet...', 'info');
                
                lucid = await Lucid.new(
                    new Blockfrost(
                        "https://cardano-preprod.blockfrost.io/api/v0",
                        "preprodYjRkHfcazNkL0xxG9C2RdUbUoTrG7wip"
                    ),
                    "Preprod"
                );

                const api = await window.cardano.lace.enable();
                lucid.selectWallet(api);

                walletAddress = await lucid.wallet.address();
                scriptAddress = lucid.utils.validatorToAddress(script);

                console.log("Connected wallet:", walletAddress);
                console.log("Script address:", scriptAddress);

                const utxos = await lucid.wallet.getUtxos();
                const totalLovelace = utxos.reduce((acc, utxo) => acc + utxo.assets.lovelace, 0n);

                document.getElementById('walletStatus').textContent = walletAddress.slice(0, 20) + '...';
                document.getElementById('walletBalance').textContent = (Number(totalLovelace) / 1000000).toFixed(2) + ' ADA';
                document.getElementById('scriptAddress').textContent = scriptAddress;
                document.getElementById('connectWallet').textContent = 'Connected';
                document.getElementById('connectWallet').disabled = true;

                document.getElementById("app").classList.remove("hidden");
                showAlert('Wallet connected successfully!', 'success');
            } catch (error) {
                showAlert('Failed to connect wallet: ' + error.message, 'error');
            }
        }

        function mkProposalDatum(proposer, fundingGoal, votingDeadline, recipient) {
            return Data.to(
                new Constr(0, [
                    proposer,
                    BigInt(fundingGoal),
                    BigInt(votingDeadline),
                    recipient,
                ])
            );
        }

        function redeemerCancelProposal() {
            return Data.to(new Constr(1, []));
        }

        async function fundProposal() {
            console.log("fundProposal function called");
            
            if (!lucid) {
                showAlert('Please connect your wallet first', 'error');
                log("ERROR: Wallet not connected");
                return;
            }

            try {
                log("Creating proposal...");
                
                const fundingGoalAda = document.getElementById("fundingGoal").value;
                console.log("Funding Goal Input:", fundingGoalAda);
                
                if (!fundingGoalAda || fundingGoalAda <= 0) {
                    showAlert('Please enter a valid funding goal (must be greater than 0)', 'error');
                    log("ERROR: Invalid funding goal");
                    return;
                }
                
                const fundingGoal = BigInt(Math.floor(parseFloat(fundingGoalAda) * 1_000_000));
                console.log("Funding Goal (lovelace):", fundingGoal.toString());
                
                const votingDeadlineInput = document.getElementById("votingDeadline").value;
                console.log("Voting Deadline Input:", votingDeadlineInput);
                
                if (!votingDeadlineInput) {
                    const fourMonthsFromNow = Date.now() + (120 * 24 * 60 * 60 * 1000);
                    document.getElementById("votingDeadline").value = fourMonthsFromNow;
                    showAlert('No deadline provided. Setting to 4 months from now: ' + fourMonthsFromNow, 'info');
                    return;
                }
                const votingDeadline = BigInt(votingDeadlineInput);
                console.log("Voting Deadline (POSIX):", votingDeadline.toString());

                let recipientPkh = document.getElementById("recipient").value.trim();
                const proposerPkh = lucid.utils.getAddressDetails(walletAddress).paymentCredential.hash;
                console.log("Proposer PKH:", proposerPkh);
                
                if (!recipientPkh) {
                    recipientPkh = proposerPkh;
                    log("Using your PKH as recipient: " + recipientPkh.slice(0, 10) + "...");
                }
                console.log("Recipient PKH:", recipientPkh);

                log("Building datum...");
                const datum = mkProposalDatum(proposerPkh, fundingGoal, votingDeadline, recipientPkh);
                console.log("Datum created");

                log("Building transaction...");
                const tx = await lucid
                    .newTx()
                    .payToContract(scriptAddress, { inline: datum }, { lovelace: fundingGoal })
                    .complete();

                log("Signing transaction...");
                const signed = await tx.sign().complete();
                
                log("Submitting transaction...");
                const txHash = await signed.submit();

                log("‚úÖ Proposal created! TX: " + txHash);
                showAlert('Proposal created! Transaction: ' + txHash, 'success');
                console.log("Transaction Hash:", txHash);
                
                // Clear form
                document.getElementById("fundingGoal").value = "";
                document.getElementById("votingDeadline").value = "";
                document.getElementById("recipient").value = "";
                
            } catch (error) {
                console.error("Full error:", error);
                log("‚ùå Error: " + error.message);
                showAlert('Failed to create proposal: ' + error.message, 'error');
            }
        }

        async function cancelProposal() {
            if (!lucid) {
                showAlert('Please connect your wallet first', 'error');
                return;
            }

            try {
                log("Canceling proposal...");
                
                const proposerPkh = lucid.utils.getAddressDetails(walletAddress).paymentCredential.hash;

                const utxos = await lucid.utxosAt(scriptAddress);

                if (utxos.length === 0) {
                    log("No proposals found to cancel");
                    showAlert('No proposals found at script address', 'error');
                    return;
                }

                const targetUtxo = utxos[0];
                log("Found UTXO: " + targetUtxo.txHash + "#" + targetUtxo.outputIndex);

                const tx = await lucid
                    .newTx()
                    .collectFrom([targetUtxo], Data.to(new Constr(1, [])))
                    .payToAddress(walletAddress, { lovelace: targetUtxo.assets.lovelace })
                    .attachSpendingValidator(script)
                    .addSignerKey(proposerPkh)
                    .validFrom(Date.now())
                    .validTo(Date.now() + 100000)
                    .complete();

                const signed = await tx.sign().complete();
                const txHash = await signed.submit();

                log("Proposal canceled! TX: " + txHash);
                showAlert('Proposal canceled! Transaction: ' + txHash, 'success');
            } catch (error) {
                log("Error: " + error.message);
                showAlert('Failed to cancel proposal: ' + error.message, 'error');
            }
        }

        document.getElementById("connectWallet").onclick = initLucid;
        document.getElementById("fundBtn").onclick = fundProposal;
        document.getElementById("cancelBtn").onclick = cancelProposal;

        // Helper function to set deadline
        window.setFourMonthsDeadline = function() {
            const fourMonths = Date.now() + (120 * 24 * 60 * 60 * 1000);
            document.getElementById("votingDeadline").value = fourMonths;
            showAlert('Deadline set to 4 months from now: ' + new Date(fourMonths).toLocaleString(), 'success');
        }

        // Update current time display
        setInterval(() => {
            const timeEl = document.getElementById("currentTime");
            if (timeEl) {
                timeEl.textContent = Date.now() + " (" + new Date().toLocaleString() + ")";
            }
        }, 1000);
    </script>
</body>
</html>